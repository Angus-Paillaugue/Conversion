(()=>{"use strict";function e(e){e?(document.querySelector(".yupoo-categories-hide-sidebar")&&(document.querySelector(".yupoo-categories-hide-sidebar").style.display="none"),document.querySelector(".categories__box-left")&&(document.querySelector(".categories__box-left").style.display="none"),document.querySelector(".categories__box-right")&&(document.querySelector(".categories__box-right").style.marginLeft="0")):(document.querySelector(".yupoo-categories-hide-sidebar")&&(document.querySelector(".yupoo-categories-hide-sidebar").style.display="block"),document.querySelector(".categories__box-left")&&(document.querySelector(".categories__box-left").style.display="block"),document.querySelector(".categories__box-right")&&(document.querySelector(".categories__box-right").style.marginLeft="216px"))}const t=["*://*.pandabuy.com/*","*://*.yupoo.com/*","https://m.weidian.com/*","https://weidian.com/*","*://*.taobao.com/*","*://*.1688.com/*","*://*.tmall.com/*"];function o(e){try{let o=!1;for(let r of t)new URLPattern(r).test(new URL(e).origin)&&(o=!0);return o}catch(e){return!1}}function r(e,t,o,r){if(e=e.replaceAll("￥","¥"),new URLPattern("https://*.pandabuy.com").test(location.origin)&&("/cartEstimatedFreight"===location.pathname||"/person/parcel/list"===location.pathname))for(const t of o)e=e.replaceAll(t.name,t.symbol);const a=[...e.matchAll(/([$€¥£₹₽₴₱₪₨₩₦₢₣₥₫₵]\s?\.?~?\s?\d+(\.\d{1,2})?|\d+(\.\d{1,2})?\s?\.?~?\s?[$€¥£₹₽₴₱₪₨₩₦₢₣₥₫₵])/g)];if(0===a.length)return e;let c="",n=0;for(const l of a){const a=l[0].match(/[$€¥£₹₽₴₱₪₨₩₦₢₣₥₫₵]/g)[0],i=parseFloat(l[0].match(/[-+]?\d+(\.\d+)?/g)[0]);if(a&&i){const s=o.filter((e=>e.symbol===a))[0];if(s.name!==r){const a=t[s.name],u=isNaN(i)?"":(parseFloat(i)/a).toFixed(2);c+=e.substring(n,l.index-1)+u+" "+o.filter((e=>e.name===r))[0].symbol,c=c.replaceAll(s.name,""),n=l.index+l[0].length}}}return c+=e.substring(n),c}function a(){chrome.storage.local.get(["pandabuyProductWarnings"],(e=>{if(e=e?.pandabuyProductWarnings??!0){let e=0,t=setInterval((()=>{if(10===e&&clearInterval(t),document.querySelector(".el-button.accept-btn.el-button--default"))try{document.querySelector(".el-button.accept-btn.el-button--default").click(),clearInterval(t)}catch(e){}e++}),200)}}))}function c(){chrome.storage.local.get(["yupooContentWidth"],(e=>{let t=e?.yupooContentWidth??170;document.querySelector(".showalbumheader__main")&&(document.querySelector(".showalbumheader__main").style.maxWidth="100%"),document.querySelector(".showindex__gallerycardwrap")&&(document.querySelector(".showindex__gallerycardwrap").style.maxWidth="100%"),document.querySelector(".showalbum__imagecardwrap")&&(document.querySelector(".showalbum__imagecardwrap").style.maxWidth="100%"),document.querySelector(".categories__box.clearfix")&&(document.querySelector(".categories__box.clearfix").style.maxWidth="100%");let o=document.querySelectorAll(".categories__parent.album__categories-box, .showalbum__parent, .showindex__parent, .showalbum__parent");for(let e of o)e.style.display="grid",e.style.gap="10px",e.style.gridTemplateColumns=`repeat(auto-fill, minmax(${t}px, 1fr))`,Array.from(e.children).forEach((e=>{e.style.width="100%",e.style.margin="0"}))}))}chrome.runtime.onMessage.addListener(((t,o,r)=>{console.log(t),"toggledSideBar"===t&&e(),"productWarningsChange"===t&&a(),"yupooContentWidthChanged"===t&&c()})),a(),chrome.storage.local.get(["status"],(e=>{(e=e?.status??!0)&&chrome.storage.local.get(["convertTo"],(e=>{var t,a;t=e=e?.convertTo??"USD",a=t=>{var a=new XMLHttpRequest;a.open("GET",chrome.runtime.getURL("currencies.json")),a.onreadystatechange=function(){if(4==this.readyState&&200===this.status){const c=JSON.parse(a.responseText),n=document.querySelector("title");n&&(n.innerText=r(n.innerText,t,c,e)),setInterval((()=>{(o(location.href)||new URLPattern("*://*.reddit.com/*").test(new URL(location.href).origin))&&document.querySelectorAll("span, p, a, h1, h2, h3, h4, h5, h6, em, tr, ul, ol, tr, label, div, dd, li").forEach((o=>{for(let a=0;a<o.childNodes.length;++a)if(o.childNodes[a].nodeType===Node.TEXT_NODE){let n=r(o.childNodes[a].textContent,t,c,e);n!==o.childNodes[a].textContent&&(o.childNodes[a].textContent=n)}}))}),1e3)}},a.send()},chrome.storage.local.get(["cache","cacheTime"],(e=>{if(e?.cache&&e?.cacheTime>Date.now()-36e5&&e?.cache?.currencyToConvertTo===t)return console.log(`PCC : Using cached ${t} conversion rates`),a(e.cache.data);console.log(`PCC : Fetching live ${t} exchange rates from api`),function(e,t){fetch(`https://api.exchangerate-api.com/v4/latest/${e}`).then((e=>e.json())).then((o=>{chrome.storage.local.set({cache:{currencyToConvertTo:e,data:o.rates},cacheTime:Date.now()},(()=>{t(o.rates)}))}))}(t,a)}))}))})),chrome.storage.local.get(["autoPandaBuyRedirect"],(e=>{(e=e?.autoPandaBuyRedirect??!0)&&function(e){if(!o(location.href))return!1;let t=!1;const r=["id","itemID"];for(const e of new URL(location.href)?.searchParams?.keys())r.includes(e)&&(t=!0);return t}()&&chrome.runtime.sendMessage({type:"updateTabURL",url:`https://www.pandabuy.com/product?url=${encodeURIComponent(location.href)}`})})),chrome.storage.local.get(["yupooInterfaceReDesign"],(t=>{let o=t?.yupooInterfaceReDesign??!0;new URLPattern("*://*.yupoo.com/*").test(location.href)&&o&&(chrome.storage.local.get(["removeYupooSideBar"],(t=>{e(t=t?.removeYupooSideBar??!0)})),c())}))})();